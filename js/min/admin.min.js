const ADMIN_PORTAL={vehicles:[],vehicleMap:new Map,activeId:null,isDirty:!1,isHydrating:!1,orders:[],addons:[],addonMap:new Map,activeAddonId:null,addonsDirty:!1,addonsHydrating:!1,discounts:[],discountMap:new Map,activeDiscountVehicleId:null,discountsDirty:!1,discountsHydrating:!1,activeSection:"vehicles"},boolFromValue=e=>e===1||e==="1"||e===!0,toInt=e=>{const t=parseInt(e,10);return Number.isNaN(t)?0:t},toFloat=e=>{const t=parseFloat(e);return Number.isNaN(t)?0:t},buildSearchKey=e=>{const t=e.name||"",n=e.type||"",s=e.slug||"";return`${t} ${n} ${s}`.toLowerCase().trim()},parseJsonScript=e=>{const t=document.getElementById(e);if(!t)return null;try{return JSON.parse(t.textContent)}catch{return null}},stripTrailingZeros=e=>typeof e!="number"||Number.isNaN(e)?"":e%1===0?e.toString():e.toFixed(2).replace(/\.?0+$/,""),setSection=e=>{const t=Array.from(document.querySelectorAll(".admin-section")),n=Array.from(document.querySelectorAll(".admin-tab"));if(t.length===0||n.length===0)return!1;const s=new Set(t.map(e=>e.dataset.section));if(!s.has(e))return!1;if(ADMIN_PORTAL.activeSection&&ADMIN_PORTAL.activeSection!==e){if(ADMIN_PORTAL.activeSection==="vehicles"&&ADMIN_PORTAL.isDirty&&!window.confirm("Discard unsaved vehicle changes?"))return!1;if(ADMIN_PORTAL.activeSection==="addons"&&ADMIN_PORTAL.addonsDirty&&!window.confirm("Discard unsaved add-on changes?"))return!1;if(ADMIN_PORTAL.activeSection==="discounts"&&ADMIN_PORTAL.discountsDirty&&!window.confirm("Discard unsaved discount changes?"))return!1}ADMIN_PORTAL.activeSection=e,n.forEach(t=>t.classList.toggle("active",t.dataset.section===e)),t.forEach(t=>{t.hidden=t.dataset.section!==e});try{localStorage.setItem("admin_section",e)}catch{}return window.location.hash.replace("#","")!==e&&history.replaceState(null,"",`#${e}`),!0},initTabs=()=>{const e=Array.from(document.querySelectorAll(".admin-tab"));if(e.length===0)return;e.forEach(e=>{e.addEventListener("click",()=>{setSection(e.dataset.section)})});const t=window.location.hash.replace("#","");if(t&&setSection(t))return;try{const e=localStorage.getItem("admin_section");if(e&&setSection(e))return}catch{}setSection(e[0].dataset.section||"vehicles")},initVehicles=()=>{const w=parseJsonScript("vehicle-data");if(!w)return;ADMIN_PORTAL.vehicles=w||[],ADMIN_PORTAL.vehicleMap=new Map(ADMIN_PORTAL.vehicles.map(e=>[String(e.id),e]));const t=document.getElementById("vehicle-form");if(!t)return;const b=document.querySelector(".vehicle-editor .editor-empty"),g=document.getElementById("vehicle-status"),o=t.querySelector(".admin-save"),i=t.querySelector(".admin-reset"),a=t.querySelector(".admin-delete"),h=document.getElementById("vehicle-add"),c=document.querySelector(".vehicle-items"),d=document.getElementById("vehicle-search"),r=document.querySelector(".vehicle-empty"),E=document.getElementById("vehicle-count");if(!t||!o||!i||!g)return;const e={id:t.querySelector('[name="id"]'),name:t.querySelector('[name="name"]'),type:t.querySelector('[name="type"]'),slug:t.querySelector('[name="slug"]'),base_price_USD:t.querySelector('[name="base_price_USD"]'),insurance:t.querySelector('[name="insurance"]'),people:t.querySelector('[name="people"]'),bags:t.querySelector('[name="bags"]'),doors:t.querySelector('[name="doors"]'),manual:t.querySelector('[name="manual"]'),ac:t.querySelector('[name="ac"]'),fourwd:t.querySelector('[name="4wd"]'),showing:t.querySelector('[name="showing"]'),landing_order:t.querySelector('[name="landing_order"]'),image_file:t.querySelector('[name="image_file"]')},s={img:document.querySelector(".preview-image img"),title:document.querySelector(".preview-title"),subtitle:document.querySelector(".preview-subtitle"),price:document.querySelector(".preview-price"),showing:document.querySelector(".showing-preview"),landing:document.querySelector(".landing-preview")},n=(e,t="")=>{g.textContent=e||"",g.classList.remove("success","error","info"),t&&g.classList.add(t)},l=e=>{ADMIN_PORTAL.isDirty=e,o.disabled=!e,t.classList.toggle("is-dirty",e)},v=(e,t,n)=>{if(!e)return;e.textContent=n,e.classList.toggle("tag-on",t),e.classList.toggle("tag-off",!t)},u=e=>e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),N=e=>e&&`${e}${e.includes("?")?"&":"?"}v=${Date.now()}`,A=(e,t=!1)=>{const n=e.image_url||(e.slug?`/assets/images/vehicles/${e.slug}.avif`:"/assets/images/logo.avif");return t?N(n):n},m=e=>{if(!e)return;const t=e.name||"Vehicle",o=e.type||"Type",i=e.base_price_USD??0,a=A(e);s.title&&(s.title.textContent=t),s.subtitle&&(s.subtitle.textContent=o),s.price&&(s.price.textContent=`USD$${i}/day`),s.img&&(s.img.src=a,s.img.alt=`${t} image`);const r=boolFromValue(e.showing),n=e.landing_order!==null&&e.landing_order!==""&&e.landing_order!==0[0],c=n?`Landing #${e.landing_order}`:"Landing Hidden";v(s.showing,r,"Showing"),v(s.landing,n,c)},j=t=>{ADMIN_PORTAL.isHydrating=!0,e.id.value=t.id??"",e.name.value=t.name??"",e.type.value=t.type??"",e.slug.value=t.slug??"",e.base_price_USD.value=t.base_price_USD??"",e.insurance.value=t.insurance??"",e.people.value=t.people??"",e.bags.value=t.bags??"",e.doors.value=t.doors??"",e.manual.checked=boolFromValue(t.manual),e.ac.checked=boolFromValue(t.ac),e.fourwd.checked=boolFromValue(t["4wd"]),e.showing.checked=boolFromValue(t.showing),e.landing_order.value=t.landing_order??"",e.image_file&&(e.image_file.value=""),ADMIN_PORTAL.isHydrating=!1},O=()=>{const t=e.landing_order.value.trim();return{id:e.id.value?parseInt(e.id.value,10):null,name:e.name.value.trim(),type:e.type.value.trim(),slug:e.slug.value.trim(),base_price_USD:toFloat(e.base_price_USD.value),insurance:toFloat(e.insurance.value),people:toInt(e.people.value),bags:toInt(e.bags.value),doors:toInt(e.doors.value),manual:e.manual.checked?1:0,ac:e.ac.checked?1:0,"4wd":e.fourwd.checked?1:0,showing:e.showing.checked?1:0,landing_order:t===""?null:toInt(t)}},f=()=>Array.from(document.querySelectorAll(".vehicle-item")),k=e=>{const t=document.createElement("button");t.type="button",t.className="vehicle-item",t.dataset.vehicleId=String(e.id),t.dataset.search=buildSearchKey(e);const s=boolFromValue(e.showing),n=e.landing_order!==null&&e.landing_order!==""&&e.landing_order!==0[0],o=n?`Landing #${e.landing_order}`:"Landing Hidden",i=s?"tag-on":"tag-off",a=n?"tag-on":"tag-off",r=boolFromValue(e.manual)?"Manual":"Automatic";return t.innerHTML=`
            <div class="vehicle-item-top">
                <div>
                    <span class="vehicle-name">${u(e.name||"Vehicle")}</span>
                    <span class="vehicle-type">${u(e.type||"")}</span>
                </div>
                <span class="vehicle-price">USD$${u(String(e.base_price_USD??0))}/day</span>
            </div>
            <div class="vehicle-item-details">
                <span class="vehicle-seats">${u(String(e.people??0))} seats</span>
                <span class="vehicle-transmission">${u(r)}</span>
            </div>
            <div class="vehicle-item-tags">
                <span class="vehicle-tag showing-tag ${i}">Showing</span>
                <span class="vehicle-tag landing-tag ${a}">${u(o)}</span>
            </div>
        `,t},C=()=>{if(!E)return;E.textContent=String(ADMIN_PORTAL.vehicleMap.size)},y=e=>{let t=document.querySelector(`.vehicle-item[data-vehicle-id="${e.id}"]`);if(!t){t=k(e),c&&(r&&r.parentNode===c?c.insertBefore(t,r):c.appendChild(t)),C();return}const n=t.querySelector(".vehicle-name"),s=t.querySelector(".vehicle-type"),o=t.querySelector(".vehicle-price"),i=t.querySelector(".vehicle-seats"),a=t.querySelector(".vehicle-transmission"),d=t.querySelector(".showing-tag"),u=t.querySelector(".landing-tag");n&&(n.textContent=e.name||"Vehicle"),s&&(s.textContent=e.type||""),o&&(o.textContent=`USD$${e.base_price_USD??0}/day`),i&&(i.textContent=`${e.people??0} seats`),a&&(a.textContent=boolFromValue(e.manual)?"Manual":"Automatic");const h=boolFromValue(e.showing),l=e.landing_order!==null&&e.landing_order!==""&&e.landing_order!==0[0],m=l?`Landing #${e.landing_order}`:"Landing Hidden";v(d,h,"Showing"),v(u,l,m),t.dataset.search=buildSearchKey(e)},p=e=>{const s=ADMIN_PORTAL.vehicleMap.get(String(e));if(!s)return;ADMIN_PORTAL.activeId=String(e),f().forEach(t=>t.classList.toggle("active",t.dataset.vehicleId===String(e))),b&&(b.hidden=!0),t.hidden=!1,j(s),m(s),l(!1),i&&(i.disabled=!1),a&&(a.disabled=!1),n("")},_=e=>{const s=f();let t=0;const n=e.toLowerCase();s.forEach(e=>{const o=(e.dataset.search||"").toLowerCase(),s=o.includes(n);e.hidden=!s,s&&t++}),r&&(r.hidden=n.length===0||t>0)},S=async t=>{const o=e.image_file&&e.image_file.files&&e.image_file.files[0]?e.image_file.files[0]:null;if(!o)return t;const n=new FormData;n.append("vehicle_id",String(t.id)),n.append("image",o);const i=await fetch("/includes/admin-vehicle-image.php",{method:"POST",body:n}),s=await i.json();if(!i.ok||!s.success)throw new Error(s.message||"Image upload failed.");const a={...t,image_url:s.image_url};return e.image_file&&(e.image_file.value=""),a},M=async()=>{if(!ADMIN_PORTAL.activeId)return;const e=O();n("Saving...","info"),o.disabled=!0;try{const a=await fetch("/includes/admin-vehicles.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update_vehicle",vehicle:e})}),s=await a.json();if(!a.ok||!s.success){n(s.message||"Save failed.","error"),o.disabled=!1;return}let t=s.vehicle;const i=ADMIN_PORTAL.vehicleMap.get(String(t.id));i&&i.image_url&&!t.image_url&&(t.image_url=i.image_url);try{t=await S(t)}catch(e){ADMIN_PORTAL.vehicleMap.set(String(t.id),t),y(t),j(t),m(t),l(!1),n(`Vehicle saved, image upload failed: ${e.message}`,"error");return}ADMIN_PORTAL.vehicleMap.set(String(t.id),t),y(t),j(t),m(t),l(!1),n("Saved","success")}catch{n("Network error.","error"),o.disabled=!1}},F=()=>{if(!ADMIN_PORTAL.activeId)return;const e=ADMIN_PORTAL.vehicleMap.get(String(ADMIN_PORTAL.activeId));if(!e)return;j(e),m(e),l(!1),n("Changes reset.","info")},T=e=>{const t=document.querySelector(`.vehicle-item[data-vehicle-id="${e}"]`);t&&t.remove(),C()},z=async()=>{if(!ADMIN_PORTAL.activeId)return;const e=String(ADMIN_PORTAL.activeId),s=ADMIN_PORTAL.vehicleMap.get(e);if(!s)return;if(ADMIN_PORTAL.isDirty&&!window.confirm("Discard unsaved changes and delete this vehicle?"))return;const c=s.name?`"${s.name}"`:`#${e}`;if(!window.confirm(`Delete vehicle ${c}? This cannot be undone.`))return;n("Deleting...","info"),o&&(o.disabled=!0),i&&(i.disabled=!0),a&&(a.disabled=!0);try{const s=await fetch("/includes/admin-vehicles.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"delete_vehicle",vehicle_id:parseInt(e,10)})}),c=await s.json();if(!s.ok||!c.success){n(c.message||"Delete failed.","error"),i&&(i.disabled=!1),a&&(a.disabled=!1),o.disabled=!ADMIN_PORTAL.isDirty;return}ADMIN_PORTAL.vehicleMap.delete(e),T(e),ADMIN_PORTAL.activeId=null;const h=d?d.value.trim():"";_(h);const m=f().filter(e=>!e.hidden),g=f(),u=m[0]||g[0]||null;u?(p(u.dataset.vehicleId),n("Vehicle deleted.","success")):(t.hidden=!0,b&&(b.hidden=!1),r&&(r.hidden=!0),l(!1),n("Vehicle deleted.","success"))}catch{n("Network error.","error"),i&&(i.disabled=!1),a&&(a.disabled=!1),o.disabled=!ADMIN_PORTAL.isDirty}},D=async()=>{if(ADMIN_PORTAL.isDirty&&!window.confirm("Discard unsaved changes and create a new vehicle?"))return;n("Creating vehicle...","info"),h&&(h.disabled=!0);const e=Date.now(),t={name:"New Vehicle",type:"car",slug:`vehicle_${e}`,base_price_USD:0,insurance:0,people:4,bags:0,doors:4,manual:0,ac:1,"4wd":0,showing:1,landing_order:null};try{const o=await fetch("/includes/admin-vehicles.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"create_vehicle",vehicle:t})}),s=await o.json();if(!o.ok||!s.success){n(s.message||"Create failed.","error");return}const e=s.vehicle;ADMIN_PORTAL.vehicleMap.set(String(e.id),e),y(e),_(d?d.value.trim():""),p(e.id),l(!0),n("Vehicle created. Update details and save.","info")}catch{n("Network error.","error")}finally{h&&(h.disabled=!1)}};c&&c.addEventListener("click",e=>{const t=e.target.closest(".vehicle-item");if(!t||!c.contains(t))return;const n=t.dataset.vehicleId;if(String(n)===String(ADMIN_PORTAL.activeId))return;if(ADMIN_PORTAL.isDirty&&!window.confirm("Discard unsaved changes?"))return;p(n)}),t.addEventListener("submit",e=>{e.preventDefault()}),t.addEventListener("input",()=>{if(ADMIN_PORTAL.isHydrating)return;l(!0),n("Unsaved changes","info"),m(O())}),o.addEventListener("click",M),i.addEventListener("click",F),a&&a.addEventListener("click",z),h&&h.addEventListener("click",D),d&&d.addEventListener("input",e=>{_(e.target.value.trim())});const x=f();x.length>0&&p(x[0].dataset.vehicleId)},initOrders=()=>{const D=document.getElementById("order-search"),i=Array.from(document.querySelectorAll(".order-row")),S=document.querySelector(".table-empty"),b=document.getElementById("order-page-size"),u=document.getElementById("order-prev"),c=document.getElementById("order-next"),T=document.getElementById("order-page-info"),o=document.getElementById("order-modal"),B=document.getElementById("order-details"),r=document.getElementById("order-form"),t=document.querySelector(".order-save"),O=document.querySelector(".order-reset"),h=document.getElementById("order-status");if(!D||i.length===0)return;const H=parseJsonScript("orders-data")||[],w=parseJsonScript("orders-config")||{},R=w.display_columns||[],g=new Map(H.map(e=>[String(e.id),e])),U=ADMIN_PORTAL.vehicleMap&&ADMIN_PORTAL.vehicleMap.size?ADMIN_PORTAL.vehicleMap:new Map((parseJsonScript("vehicle-data")||[]).map(e=>[String(e.id),e])),n=r?{id:r.querySelector('[name="id"]'),status:r.querySelector('[name="status"]')}:null,j=document.getElementById("order-detail-image"),A=document.getElementById("order-detail-vehicle-name"),k=document.getElementById("order-detail-vehicle-type"),E=document.getElementById("order-detail-vehicle-price"),M=document.getElementById("order-detail-vehicle-capacity"),x=document.getElementById("order-detail-vehicle-features");let Y=!1,a=null,e=1,p=b?parseInt(b.value,10):10,v=i.slice();const l=()=>{const t=Math.max(1,Math.ceil(v.length/p));e>t&&(e=t),e<1&&(e=1);const n=(e-1)*p,s=n+p;i.forEach(e=>{e.hidden=!0}),v.slice(n,s).forEach(e=>{e.hidden=!1}),T&&(T.textContent=`Page ${e} of ${t}`),u&&(u.disabled=e<=1),c&&(c.disabled=e>=t),S&&(S.hidden=v.length>0)},F=t=>{const n=t.toLowerCase();v=i.filter(e=>{const t=(e.dataset.search||"").toLowerCase();return t.includes(n)}),e=1,l()},P=e=>{const t=parseFloat(e);return Number.isNaN(t)?"—":`USD$${t.toFixed(2)}`},z=e=>e==null||e===""?null:U.get(String(e))||null,f=e=>{if(e==null)return"—";const t=String(e).trim();if(t===""||t==="—")return"—";if(!/^\d+$/.test(t))return t;const n=z(t);return n&&n.name?n.name:`Car ${t}`},I=(e,t)=>{const n=t||z(e?.car_id);return{name:n?.name??e?.vehicle_name??"Vehicle",type:n?.type??e?.vehicle_type??"",slug:n?.slug??e?.vehicle_slug??"",basePrice:n?.base_price_USD??e?.vehicle_base_price??null,people:n?.people??e?.vehicle_people??null,bags:n?.bags??e?.vehicle_bags??null,doors:n?.doors??e?.vehicle_doors??null,manual:n?.manual??e?.vehicle_manual??null,ac:n?.ac??e?.vehicle_ac??null,fourwd:n?n["4wd"]:e?.vehicle_4wd??null}},L=(e,t)=>{if(!e&&!t)return;const n=I(e||{},t),o=n.name||"Vehicle",i=n.slug||"",a=i?`/assets/images/vehicles/${i}.avif`:"/assets/images/logo.avif";if(j&&(j.src=a,j.alt=`${o} image`),A&&(A.textContent=o),k&&(k.textContent=n.type||""),E){const e=n.basePrice;E.textContent=e!=null&&e!==""?`USD$${e}/day`:"USD$—/day"}if(M){const e=n.people?`${n.people} seats`:null,t=n.bags?`${n.bags} bags`:null;M.textContent=[e,t].filter(Boolean).join(" • ")||"—"}const s=[];if(n.manual!==null&&n.manual!==0[0]&&s.push(parseInt(n.manual,10)===1?"Manual":"Automatic"),n.ac!==null&&n.ac!==0[0]&&parseInt(n.ac,10)===1&&s.push("AC"),n.fourwd!==null&&n.fourwd!==0[0]&&parseInt(n.fourwd,10)===1&&s.push("4WD"),n.doors!==null&&n.doors!==0[0]){const e=parseInt(n.doors,10);!Number.isNaN(e)&&e>0&&s.push(`${e} doors`)}x&&(x.textContent=s.length?s.join(" • "):"—")},_=()=>{if(!o)return;o.hidden=!0,document.body.classList.remove("modal-open")},W=()=>{if(!o)return;o.hidden=!1,document.body.classList.add("modal-open")},s=(e,t="")=>{if(!h)return;h.textContent=e||"",h.classList.remove("success","error","info"),t&&h.classList.add(t)},N=e=>{Y=e,t&&(t.disabled=!e)},y=e=>{if(!n||!e)return;n.id&&(n.id.value=e.id??""),n.status&&(n.status.value=e.status??"pending"),N(!1),s("")},V=e=>{const t=[e.id,e.customer_name,e.email,e.phone,e.vehicle_name,e.pick_up_location,e.drop_off_location];return t.filter(Boolean).join(" ").toLowerCase().trim()},$=e=>{const t=document.querySelector(`.order-row[data-order-id="${e.id}"]`);if(!t)return;const n=Array.from(t.querySelectorAll("td"));R.forEach((t,s)=>{const i=n[s];if(!i)return;let o=e[t]??"";t==="status"&&(o=(e.status||"pending").replace(/^\w/,e=>e.toUpperCase())),t==="sub_total"&&o!==""&&(o=`USD$${parseFloat(o).toFixed(2)}`),i.textContent=o}),t.dataset.search=V(e)},d=e=>e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),m=(e,t)=>{if(!e||!t)return null;const s=t.split(".");let n=e;for(const e of s)if(n&&Object.prototype.hasOwnProperty.call(n,e))n=n[e];else return null;return n},K=(e,t,n)=>{const s=e.split(",").map(e=>e.trim()).filter(Boolean);if(s.length===0)return[];const o=t?.order||t||{},i=n?.order||n||{},a=t?.contact||{},r=n?.contact||{};return s.map(e=>{let t=null,n=null;if(e.startsWith("contact.")){const s=e.replace("contact.","");t=m(a,s),n=m(r,s)}else t=m(o,e),n=m(i,e);const s=e==="car_id"?"car":e,c=e==="car_id"?f(t):t==null||t===""?"—":t,l=e==="car_id"?f(n):n==null||n===""?"—":n;return`${s}: ${c} → ${l}`})},q=e=>{if(!e)return e;const t=e.match(/^car_id:\s*(.*?)\s*→\s*(.*)$/i);if(t){const e=f(t[1]),n=f(t[2]);return`car: ${e} → ${n}`}return e},C=async e=>{const n=document.getElementById("order-history"),t=document.getElementById("order-history-list");if(!n||!t)return;if(!w.has_history){n.hidden=!0;return}n.hidden=!1,t.textContent="Loading history...";try{const s=await fetch("/includes/admin-orders.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"fetch_history",order_id:e})}),n=await s.json();if(console.log("here is the result",n),!s.ok||!n.success){t.textContent=n.message||"Unable to load history.";return}if(!n.history||n.history.length===0){t.textContent="No history yet.";return}t.innerHTML=n.history.map(e=>{const n=e.change_summary||e.action||"Update",s=e.created_at||"",o=e.admin_user||"Admin";let t=n.split(`
`).filter(Boolean);if(t.length<=1&&n.indexOf("→")===-1){let s=null,o=null;try{s=e.previous_data?JSON.parse(e.previous_data):null}catch{s=null}try{o=e.new_data?JSON.parse(e.new_data):null}catch{o=null}const i=K(n,s,o);i.length>0&&(t=i)}t=t.map(q);const i=t.length>1?`<div class="order-history-lines">${t.map(e=>`<div>${d(e)}</div>`).join("")}</div>`:`<strong>${d(t[0]||n)}</strong>`;return`<div class="order-history-item">${i}<span>${d(s)} · ${d(o)}</span></div>`}).join("")}catch{t.textContent="Unable to load history."}},G=async()=>{if(!n||!a)return;const e={id:a,status:n.status?n.status.value:null};s("Saving...","info"),t&&(t.disabled=!0);try{const a=await fetch("/includes/admin-orders.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update_order",order:e})}),o=await a.json();if(!a.ok||!o.success){s(o.message||"Save failed.","error"),t&&(t.disabled=!1);return}const n=o.order,i=g.get(String(n.id));i&&Array.isArray(i.add_ons)&&(n.add_ons=i.add_ons),g.set(String(n.id),n),$(n),y(n),L(n),s("Saved","success"),await C(n.id)}catch{s("Network error.","error"),t&&(t.disabled=!1)}},X=()=>{if(!a)return;const e=g.get(String(a));if(!e)return;y(e),s("Changes reset.","info")},Q=e=>{if(!B||!o)return;if(!e){_();return}const t=(e,t)=>{const n=document.getElementById(e);if(!n)return;t==null||t===""?n.textContent="—":n.textContent=t};L(e),t("order-detail-customer",e.customer_name),t("order-detail-email",e.email),t("order-detail-phone",e.phone),t("order-detail-vehicle",e.vehicle_name),t("order-detail-days",e.days),t("order-detail-subtotal",P(e.sub_total)),t("order-detail-pickup",e.pick_up),t("order-detail-dropoff",e.drop_off),t("order-detail-pickup-location",e.pick_up_location),t("order-detail-dropoff-location",e.drop_off_location),t("order-detail-driver-license",e.driver_license),t("order-detail-hotel",e.hotel),t("order-detail-country",e.country_or_region),t("order-detail-street",e.street),t("order-detail-town",e.town_or_city),t("order-detail-state",e.state_or_county);const n=document.getElementById("order-detail-addons");if(n){const t=e.add_ons||[];if(t.length===0)n.textContent="No add-ons.";else{const e=t.map(e=>{const t=e.quantity?`x${e.quantity}`:"",n=e.cost!==null&&e.cost!==0[0]&&!Number.isNaN(parseFloat(e.cost))?` - USD$${stripTrailingZeros(parseFloat(e.cost))}`:"";return`${e.name} ${t}${n}`.trim()});n.textContent=e.join(" | ")}}y(e),a=e.id,C(e.id),W()};i.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.orderId;i.forEach(e=>e.classList.remove("active")),e.classList.add("active"),Q(g.get(String(t)))})}),r&&r.addEventListener("input",()=>{if(!a)return;N(!0),s("Unsaved changes","info")}),t&&t.addEventListener("click",G),O&&O.addEventListener("click",X),o&&o.addEventListener("click",e=>{e.target&&e.target.matches("[data-modal-close]")&&_()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&_()}),b&&b.addEventListener("change",t=>{const n=parseInt(t.target.value,10);Number.isNaN(n)||(p=n,e=1,l())}),u&&u.addEventListener("click",()=>{e-=1,l()}),c&&c.addEventListener("click",()=>{e+=1,l()}),D.addEventListener("input",e=>{F(e.target.value.trim())}),F("")},initAddons=()=>{const g=parseJsonScript("addons-data");if(!g)return;const f=parseJsonScript("addons-config")||{},e=f.field_map||{},r=f.id_field||"id";ADMIN_PORTAL.addons=g||[],ADMIN_PORTAL.addonMap=new Map(ADMIN_PORTAL.addons.map(e=>[String(e[r]),e]));const n=document.getElementById("addon-form"),p=document.querySelector(".addon-empty-state"),a=document.getElementById("addon-status"),o=document.querySelector(".addon-save"),u=document.querySelector(".addon-reset"),i=Array.from(document.querySelectorAll(".addon-item")),h=document.getElementById("addon-search"),d=document.querySelector(".addon-empty");if(!n||!o||!u||!a)return;const t={id:n.querySelector('[name="id"]'),name:n.querySelector('[name="name"]'),price:n.querySelector('[name="price"]'),description:n.querySelector('[name="description"]'),active:n.querySelector('[name="active"]'),per_day:n.querySelector('[name="per_day"]'),sort_order:n.querySelector('[name="sort_order"]')},y=e=>{const t=document.querySelectorAll(`[data-addon-field="${e}"]`);t.forEach(e=>{e.hidden=!0})};Object.keys(t).forEach(t=>{if(t==="id")return;e[t]||y(t)});const s=(e,t="")=>{a.textContent=e||"",a.classList.remove("success","error","info"),t&&a.classList.add(t)},c=e=>{ADMIN_PORTAL.addonsDirty=e,o.disabled=!e,n.classList.toggle("is-dirty",e)},v=t=>{const n=[];return["name","description","price"].forEach(s=>{const o=e[s];o&&t[o]&&n.push(t[o])}),n.join(" ").toLowerCase().trim()},l=n=>{ADMIN_PORTAL.addonsHydrating=!0,t.id.value=n[r]??"",e.name&&(t.name.value=n[e.name]??""),e.price&&(t.price.value=n[e.price]??""),e.description&&(t.description.value=n[e.description]??""),e.active&&(t.active.checked=boolFromValue(n[e.active])),e.per_day&&(t.per_day.checked=boolFromValue(n[e.per_day])),e.sort_order&&(t.sort_order.value=n[e.sort_order]??""),ADMIN_PORTAL.addonsHydrating=!1},b=()=>({id:t.id.value?parseInt(t.id.value,10):null,name:t.name.value.trim(),price:t.price.value===""?null:toFloat(t.price.value),description:t.description.value.trim(),active:t.active?t.active.checked?1:0:null,per_day:t.per_day&&t.per_day.checked?1:0,sort_order:t.sort_order.value===""?null:toInt(t.sort_order.value)}),j=t=>{const l=t[r],n=document.querySelector(`.addon-item[data-addon-id="${l}"]`);if(!n)return;const o=n.querySelector(".addon-name"),i=n.querySelector(".addon-price"),s=n.querySelectorAll(".vehicle-tag"),d=e.name?t[e.name]:"Add-on";let a="—";if(e.price&&t[e.price]!==null&&t[e.price]!==0[0]){const n=parseFloat(t[e.price]);a=Number.isNaN(n)?"—":`USD$${stripTrailingZeros(n)}`}const c=!!e.per_day&&boolFromValue(t[e.per_day]);o&&(o.textContent=d||"Add-on"),i&&(i.textContent=a),s.length>=1&&(s[0].classList.toggle("tag-on",c),s[0].classList.toggle("tag-off",!c)),n.dataset.search=v(t)},m=e=>{const t=ADMIN_PORTAL.addonMap.get(String(e));if(!t)return;ADMIN_PORTAL.activeAddonId=String(e),i.forEach(t=>t.classList.toggle("active",t.dataset.addonId===String(e))),p&&(p.hidden=!0),n.hidden=!1,l(t),c(!1),s("")},_=e=>{let t=0;const n=e.toLowerCase();i.forEach(e=>{const o=(e.dataset.search||"").toLowerCase(),s=o.includes(n);e.hidden=!s,s&&t++}),d&&(d.hidden=n.length===0||t>0)},w=async()=>{if(!ADMIN_PORTAL.activeAddonId)return;const e=b();s("Saving...","info"),o.disabled=!0;try{const n=await fetch("/includes/admin-addons.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update_addon",addon:e})}),t=await n.json();if(!n.ok||!t.success){s(t.message||"Save failed.","error"),o.disabled=!1;return}ADMIN_PORTAL.addonMap.set(String(t.addon[r]),t.addon),j(t.addon),l(t.addon),c(!1),s("Saved","success")}catch{s("Network error.","error"),o.disabled=!1}},O=()=>{if(!ADMIN_PORTAL.activeAddonId)return;const e=ADMIN_PORTAL.addonMap.get(String(ADMIN_PORTAL.activeAddonId));if(!e)return;l(e),c(!1),s("Changes reset.","info")};i.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.addonId;if(String(t)===String(ADMIN_PORTAL.activeAddonId))return;if(ADMIN_PORTAL.addonsDirty&&!window.confirm("Discard unsaved changes?"))return;m(t)})}),n.addEventListener("submit",e=>{e.preventDefault()}),n.addEventListener("input",()=>{if(ADMIN_PORTAL.addonsHydrating)return;c(!0),s("Unsaved changes","info")}),o.addEventListener("click",w),u.addEventListener("click",O),h&&h.addEventListener("input",e=>{_(e.target.value.trim())}),i.length>0&&m(i[0].dataset.addonId)},initDiscounts=()=>{const f=parseJsonScript("discounts-data");if(!f)return;const r=parseJsonScript("discounts-config")||{},w=r.field_map||{},j=r.value_kind||"amount",b=r.currency||"USD";ADMIN_PORTAL.discounts=f||[],ADMIN_PORTAL.discountMap=new Map(ADMIN_PORTAL.discounts.map(e=>[String(e.vehicle?.id??e.vehicle_id),e]));const t=document.getElementById("discount-form"),g=document.querySelector(".discount-empty-state"),a=document.getElementById("discount-status"),s=document.querySelector(".discount-save"),d=document.querySelector(".discount-reset"),o=Array.from(document.querySelectorAll(".discount-item")),u=document.getElementById("discount-search"),h=document.querySelector(".discount-empty"),m=document.querySelector(".discount-vehicle-title"),l=document.querySelector(".discount-vehicle-subtitle"),p=document.querySelector(".discount-vehicle-price");if(!t||!s||!d||!a)return;const e={vehicle_id:t.querySelector('[name="vehicle_id"]'),price_USD:t.querySelector('[name="price_USD"]'),price_XCD:t.querySelector('[name="price_XCD"]'),days:t.querySelector('[name="days"]')},x=e=>{const t=document.querySelectorAll(`[data-discount-field="${e}"]`);t.forEach(e=>{e.hidden=!0})};Object.keys(e).forEach(e=>{if(e==="vehicle_id")return;w[e]||x(e)});const n=(e,t="")=>{a.textContent=e||"",a.classList.remove("success","error","info"),t&&a.classList.add(t)},i=e=>{ADMIN_PORTAL.discountsDirty=e,s.disabled=!e,t.classList.toggle("is-dirty",e)},y=e=>{if(!e)return"No discount";const s=e.price_USD!==null&&e.price_USD!==""?parseFloat(e.price_USD):null,o=e.price_XCD!==null&&e.price_XCD!==""?parseFloat(e.price_XCD):null;let t=null,n=b;return Number.isNaN(s)?Number.isNaN(o)||(t=o,n="XCD"):(t=s,n="USD"),t===null?"No discount":e.days&&!Number.isNaN(parseInt(e.days,10))?`${n}$${stripTrailingZeros(t)} for ${parseInt(e.days,10)} days`:j==="percent"?`${stripTrailingZeros(t)}% off`:`${n}$${stripTrailingZeros(t)} off`},_=e=>{const a=e.vehicle?.id??e.vehicle_id,n=document.querySelector(`.discount-item[data-vehicle-id="${a}"]`);if(!n)return;const i=n.querySelector(".discount-summary"),s=n.querySelector(".vehicle-tag"),t=e.discount||{},r=t.price_USD!==null&&t.price_USD!==""&&!Number.isNaN(parseFloat(t.price_USD))||t.price_XCD!==null&&t.price_XCD!==""&&!Number.isNaN(parseFloat(t.price_XCD)),o=r;i&&(i.textContent=y(t)),s&&(s.textContent=o?"Active":"Inactive",s.classList.toggle("tag-on",o),s.classList.toggle("tag-off",!o));const c=[e.vehicle?.name,e.vehicle?.type,e.vehicle?.slug].filter(Boolean).join(" ");n.dataset.search=c.toLowerCase().trim()},c=t=>{const n=t.vehicle||{},o=t.discount||{};ADMIN_PORTAL.discountsHydrating=!0,e.vehicle_id.value=n.id??"",e.price_USD&&(e.price_USD.value=o.price_USD??""),e.price_XCD&&(e.price_XCD.value=o.price_XCD??""),e.days&&(e.days.value=o.days??""),ADMIN_PORTAL.discountsHydrating=!1,m&&(m.textContent=n.name||"Vehicle"),l&&(l.textContent=n.type||"");const s=n.base_price_USD;p&&(p.textContent=s!=null&&s!==""?`Base USD$${s}/day`:"Base price unavailable")},O=()=>({price_USD:e.price_USD&&e.price_USD.value!==""?toFloat(e.price_USD.value):null,price_XCD:e.price_XCD&&e.price_XCD.value!==""?toFloat(e.price_XCD.value):null,days:e.days&&e.days.value!==""?toInt(e.days.value):null}),v=e=>{const s=ADMIN_PORTAL.discountMap.get(String(e));if(!s)return;ADMIN_PORTAL.activeDiscountVehicleId=String(e),o.forEach(t=>t.classList.toggle("active",t.dataset.vehicleId===String(e))),g&&(g.hidden=!0),t.hidden=!1,c(s),i(!1),n("")},C=e=>{let t=0;const n=e.toLowerCase();o.forEach(e=>{const o=(e.dataset.search||"").toLowerCase(),s=o.includes(n);e.hidden=!s,s&&t++}),h&&(h.hidden=n.length===0||t>0)},E=async()=>{if(!ADMIN_PORTAL.activeDiscountVehicleId)return;const e=O();n("Saving...","info"),s.disabled=!0;try{const a=await fetch("/includes/admin-discounts.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update_discount",vehicle_id:parseInt(ADMIN_PORTAL.activeDiscountVehicleId,10),discount:e})}),o=await a.json();if(!a.ok||!o.success){n(o.message||"Save failed.","error"),s.disabled=!1;return}const t=ADMIN_PORTAL.discountMap.get(String(ADMIN_PORTAL.activeDiscountVehicleId));t&&(t.discount=o.discount,_(t),c(t)),i(!1),n("Saved","success")}catch{n("Network error.","error"),s.disabled=!1}},k=()=>{if(!ADMIN_PORTAL.activeDiscountVehicleId)return;const e=ADMIN_PORTAL.discountMap.get(String(ADMIN_PORTAL.activeDiscountVehicleId));if(!e)return;c(e),i(!1),n("Changes reset.","info")};o.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.vehicleId;if(String(t)===String(ADMIN_PORTAL.activeDiscountVehicleId))return;if(ADMIN_PORTAL.discountsDirty&&!window.confirm("Discard unsaved changes?"))return;v(t)})}),t.addEventListener("submit",e=>{e.preventDefault()}),t.addEventListener("input",()=>{if(ADMIN_PORTAL.discountsHydrating)return;i(!0),n("Unsaved changes","info")}),s.addEventListener("click",E),d.addEventListener("click",k),u&&u.addEventListener("input",e=>{C(e.target.value.trim())}),o.length>0&&v(o[0].dataset.vehicleId)};$(function(){initTabs(),initVehicles(),initOrders(),initAddons(),initDiscounts()})